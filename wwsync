#!/usr/bin/env python3
import os
import sys
import json
import subprocess
import argparse
from pathlib import Path

# Config path
CONFIG_PATH = Path.home() / ".wwsync"

class Colors:
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    GREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'

def load_config():
    if not CONFIG_PATH.exists():
        # Create extended example if file doesn't exist
        default_config = {
            "servers": {
                "example": {
                    "host": "user@192.168.1.10",
                    "mappings": [
                        {
                            "local": "/Users/user/projects/my-app",
                            "remote": "/var/www/my-app",
                            "excludes": [".git", "node_modules", "build", ".env", "*.log"]
                        }
                    ]
                }
            }
        }
        save_config(default_config)
        return default_config
    try:
        with open(CONFIG_PATH, 'r') as f:
            return json.load(f)
    except json.JSONDecodeError:
        print(f"{Colors.FAIL}Error: .wwsync file is corrupted (invalid JSON).{Colors.ENDC}")
        sys.exit(1)

def save_config(config):
    with open(CONFIG_PATH, 'w') as f:
        json.dump(config, f, indent=4)

def run_rsync(host, local_path, remote_path, excludes, full_sync):
    # Ensure local path ends with slash for rsync content copying
    src = str(local_path)
    if not src.endswith(os.sep):
        src += os.sep
    
    # Base command
    base_cmd = ["rsync", "-avzP"]
    for exc in excludes:
        base_cmd.extend(["--exclude", exc])
    
    # Paths
    paths = [src, f"{host}:{remote_path}"]

    if not full_sync:
        # === SAFE MODE (No delete) ===
        print(f"{Colors.HEADER}>>> Syncing (Safe Mode): {local_path} -> {host}:{remote_path}{Colors.ENDC}")
        print(f"{Colors.BLUE}Files missing locally will NOT be deleted on the server.{Colors.ENDC}")
        
        cmd = base_cmd + paths
        try:
            subprocess.run(cmd, check=True)
            print(f"{Colors.GREEN}✔ Sync completed successfully.{Colors.ENDC}")
        except subprocess.CalledProcessError:
            print(f"{Colors.FAIL}✖ Sync failed.{Colors.ENDC}")

    else:
        # === FULL SYNC (--full) ===
        print(f"{Colors.HEADER}>>> Full Sync (Full Mode): {local_path} -> {host}:{remote_path}{Colors.ENDC}")
        print(f"{Colors.WARNING}Checking for files to delete on remote...{Colors.ENDC}")

        # 1. Dry Run to identify deletions
        check_cmd = base_cmd + ["--delete", "--dry-run"] + paths
        
        try:
            result = subprocess.run(check_cmd, capture_output=True, text=True)
            
            files_to_delete = []
            for line in result.stdout.splitlines():
                if line.strip().startswith("deleting "):
                    files_to_delete.append(line.strip())

            if files_to_delete:
                print(f"\n{Colors.FAIL}{Colors.BOLD}WARNING! The following files will be DELETED on the server:{Colors.ENDC}")
                for f in files_to_delete:
                    print(f"  - {f}")
                
                print(f"\n{Colors.WARNING}Total files to delete: {len(files_to_delete)}{Colors.ENDC}")
                confirm = input(f"Are you sure you want to continue? ({Colors.GREEN}y{Colors.ENDC}/{Colors.FAIL}n{Colors.ENDC}): ").strip().lower()
                
                if confirm != 'y':
                    print(f"{Colors.FAIL}Operation cancelled.{Colors.ENDC}")
                    return
            else:
                print(f"{Colors.GREEN}No files need to be deleted.{Colors.ENDC}")

            # 2. Execute Real Command
            real_cmd = base_cmd + ["--delete"] + paths
            subprocess.run(real_cmd, check=True)
            print(f"{Colors.GREEN}✔ Full sync completed.{Colors.ENDC}")

        except subprocess.CalledProcessError as e:
            print(f"{Colors.FAIL}Error executing rsync.{Colors.ENDC}")
            print(e.stderr)

def run_remote_session(host, remote_path, shell_type="bash"):
    print(f"\n{Colors.HEADER}>>> Starting Remote Session{Colors.ENDC}")
    print(f"Server: {Colors.BLUE}{host}{Colors.ENDC}")
    print(f"Path: {Colors.BLUE}{remote_path}{Colors.ENDC}")
    
    # Simply cd to the directory and start the shell
    remote_cmd = f"cd {remote_path} && exec {shell_type}"
    
    try:
        subprocess.run(["ssh", "-t", host, remote_cmd])
    except subprocess.CalledProcessError:
        print(f"{Colors.FAIL}Error establishing SSH session.{Colors.ENDC}")

def main():
    parser = argparse.ArgumentParser(description=f"{Colors.BOLD}WWSync - Super Simple Rsync Wrapper{Colors.ENDC}")
    parser.add_argument("server_alias", nargs="?", help="Server alias from config")
    parser.add_argument("-f", "--full", action="store_true", help="Full sync (deletes local-missing files on remote)")
    parser.add_argument("-s", "--sync", action="store_true", help="Safe sync (upload only, no delete)")
    parser.add_argument("-r", "--run", action="store_true", help="Run remote session after sync (if any)")
    
    args = parser.parse_args()

    if not args.server_alias:
        parser.print_help()
        sys.exit(1)
        
    if not (args.sync or args.full or args.run):
        parser.print_help()
        print(f"\n{Colors.WARNING}Please specify an action: -s (sync), -f (full sync), or -r (run){Colors.ENDC}")
        sys.exit(1)

    server_alias = args.server_alias
    config = load_config()
    
    current_dir_path = Path.cwd().resolve()

    # 1. Check/Create Server Config
    if server_alias not in config.get("servers", {}):
        print(f"{Colors.WARNING}Server '{server_alias}' not found in config.{Colors.ENDC}")
        host_address = input(f"Enter connection address (user@ip): ").strip()
        if not host_address: sys.exit(1)
        
        if "servers" not in config: config["servers"] = {}
        config["servers"][server_alias] = {"host": host_address, "mappings": []}
        save_config(config)

    server_config = config["servers"][server_alias]
    host = server_config["host"]
    shell_type = server_config.get("shell", "bash")
    mappings = server_config.get("mappings", [])

    # 2. Find mapping for current directory
    active_mapping = next(
        (m for m in mappings if Path(m["local"]).resolve() == current_dir_path), 
        None
    )

    # 3. Create mapping if not exists
    if not active_mapping:

        print(f"{Colors.WARNING}No sync configuration found for this folder on '{server_alias}'.{Colors.ENDC}")
        remote_path = input(f"Enter remote destination path: ").strip()
        if not remote_path: sys.exit(1)
        
        print("Enter exclusions separated by commas (e.g. .git, node_modules).")
        print(f"{Colors.BLUE}Note: Excluded files are never deleted, even in --full mode.{Colors.ENDC}")
        
        excludes_input = input("Excludes [Enter to skip]: ").strip()
        excludes = [e.strip() for e in excludes_input.split(',')] if excludes_input else []
        
        active_mapping = {
            "local": str(current_dir_path),
            "remote": remote_path,
            "excludes": excludes
        }
        mappings.append(active_mapping)
        config["servers"][server_alias]["mappings"] = mappings
        save_config(config)
        print(f"{Colors.GREEN}Configuration saved!{Colors.ENDC}")

    # 4. Execute Actions
    # Sync first if requested
    if args.sync or args.full:
        run_rsync(
            host, 
            active_mapping["local"], 
            active_mapping["remote"], 
            active_mapping["excludes"],
            full_sync=args.full
        )
    
    # Run second if requested
    if args.run:
        run_remote_session(
            host,
            active_mapping["remote"],
            shell_type=shell_type
        )

if __name__ == "__main__":
    main()